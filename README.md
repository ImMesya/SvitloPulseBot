# SvitloPulse

**SvitloPulse** — це простий сервіс для відстеження наявності світла (електрики). Пристрій у вас вдома періодично надсилає на сервер сигнал «я живий». Якщо сервер перестає отримувати ці сигнали більше ніж на 5 хвилин, він надсилає вам повідомлення в Telegram: «Світло вимкнули». Коли сигнали знову з’являються — «Світло увімкнули».

Корисно, щоб з відстані розуміти, чи є зараз світло вдома (наприклад, після відключень чи під час від’їзду).

---

## Як це працює

1. **Пристрій у вас вдома** (наприклад, ESP32 з MicroPython) кожні 60 секунд надсилає на ваш сервер HTTP-запит:
   ```
   GET http://ВАШ_СЕРВЕР:5000/heartbeat?token=ВАШ_СЕКРЕТНИЙ_ТОКЕН
   ```

2. **Сервер** (цей проект, `app.py`) приймає ці запити і запам’ятовує час останнього сигналу.

3. **Фонова перевірка** на сервері кожні 30 секунд дивиться:
   - якщо останній heartbeat був **більше 5 хвилин тому** — сервер вважає, що світло вимкнули, і відправляє в Telegram: **«⚠ Світло вимкнули»**;
   - якщо після «вимкнення» знову прийшов heartbeat — відправляє: **«✅ Світло увімкнули»**.

4. **Ви** отримуєте повідомлення в обраний чат/канал Telegram.

Схема:

```
[ESP32 вдома] -- Wi‑Fi --> [Інтернет] --> [Ваш сервер (VPS)] --> [Telegram]
      |                           |                |
  Кожні 60 с                  Порт 5000      Якщо немає heartbeat
  GET /heartbeat              відкритий       > 5 хв → повідомлення
```

### Повідомлення в Telegram

Бот надсилає два типи повідомлень і в обох вказує **тривалість** та **час**:

- **Коли світло зникає** («Світло вимкнули»): скільки часу світло було перед вимкненням і коли прийшов останній сигнал (приблизний час вимкнення).  
  Приклад:  
  `⚠ Світло вимкнули. Світло було 2 год 45 хв (останній сигнал о 04.02 17:15).`

- **Коли світло з’являється знову** («Світло увімкнули»): скільки часу світла не було і о котрій його вимкнули.  
  Приклад:  
  `✅ Світло увімкнули. Без світла було 1 год 15 хв (вимкнули о 04.02 14:30).`

Час у повідомленнях — за сервером (UTC). Тривалість показується в хвилинах або в годинах і хвилинах (наприклад, «45 хв», «1 год 30 хв»).

---

## Що потрібно для запуску

- **Комп’ютер або VPS** з публічною IP-адресою, щоб сервер був доступний з інтернету.
- **Python 3.8+** на цьому комп’ютері/VPS.
- **Telegram-бот** і **chat_id** чату або каналу, куди будуть летіти повідомлення.
- **Пристрій, який надсилає heartbeat** — у репозиторії є приклад для **ESP32** на **MicroPython** (платка підключається до Wi‑Fi і раз на хвилину робить GET-запит).

Далі — покрокова настройка для того, хто робить це вперше.

---

## Частина 1: Telegram-бот і chat_id

### Крок 1.1: Створити бота

1. Відкрийте Telegram і знайдіть бота **@BotFather**.
2. Напишіть йому: `/newbot`.
3. Введіть назву бота (наприклад, «SvitloPulse») і потім username (наприклад, `svitlopulse_bot`). Username має закінчуватися на `bot`.
4. BotFather надішле вам **токен** виду `123456789:ABCdefGHI...`. **Збережіть його** — він потрібен для `app.py` як `TELEGRAM_TOKEN`. Нікому його не показуйте.

### Крок 1.2: Дізнатися chat_id

Повідомлення будуть надсилатися в чат (або канал). Потрібен **chat_id** цього чату.

**Варіант А — особистий чат з ботом**

1. Знайдіть свого бота в Telegram за username і натисніть **Start** (або напишіть йому будь-що).
2. Відкрийте в браузері (підставте свій токен замість `ТОКЕН_БОТА`):
   ```
   https://api.telegram.org/botТОКЕН_БОТА/getUpdates
   ```
3. У відповіді в полі `"chat":{"id": ...}` буде число — це ваш **chat_id** (наприклад, `123456789`). Можливо, спочатку треба ще раз написати боту повідомлення і оновити сторінку.

**Варіант Б — канал**

1. Додайте бота в канал як адміністратора (з правом публікувати повідомлення).
2. Chat_id каналу зазвичай має вигляд `-1001234567890`. Його можна побачити в тому ж `getUpdates` після того, як хтось (або ви) опублікує в каналі повідомлення, або використати боти/сайти, що показують chat_id каналу по посиланню.

Запишіть отриманий **chat_id** — він потрібен для `app.py` як `CHAT_ID`.

---

## Частина 2: Сервер (app.py)

Сервер приймає heartbeat і відправляє повідомлення в Telegram. Його потрібно запустити на комп’ютері або VPS, до якого є доступ з інтернету (наприклад, ваш домашній ПК з проброшеним портом або VPS у хмарі).

### Крок 2.1: Встановити Python

- **Windows:** завантажте інсталятор з [python.org](https://www.python.org/downloads/) і під час встановлення поставте галочку «Add Python to PATH».
- **Linux (Ubuntu/Debian):** зазвичай вже є; якщо ні: `sudo apt update && sudo apt install python3 python3-pip`.
- **macOS:** `python3` часто вже встановлений, або встановіть через Homebrew.

У терміналі перевірте:

```bash
python3 --version
```

Має бути 3.8 або новіше.

### Крок 2.2: Скачати проект і встановити залежності

На комп’ютері, де буде працювати сервер:

```bash
cd шлях_до_папки_SvitloPulseBot
pip install -r requirements.txt
```

або:

```bash
pip install flask requests
```

### Крок 2.3: Налаштувати app.py

Відкрийте файл **`app.py`** у текстовому редакторі. Знайдіть блок конфігурації на початку і змініть три змінні:

```python
TELEGRAM_TOKEN = "123456789:ABCdef..."   # Токен від @BotFather
CHAT_ID = "123456789"                    # Ваш chat_id (число або рядок, наприклад "-1001234567890" для каналу)
SECRET_TOKEN = "XYZ"                     # Будь-який секретний рядок — його треба вказати в пристрої (ESP32)
```

- **TELEGRAM_TOKEN** — токен бота з кроку 1.1.  
- **CHAT_ID** — chat_id з кроку 1.2 (можна в лапках як рядок).  
- **SECRET_TOKEN** — придумайте свій пароль (наприклад, довгий випадковий рядок). **Той самий** рядок потрібно буде вказати в скрипті на ESP32 в параметрі `token=` у посиланні heartbeat. Це захищає ендпоінт від сторонніх запитів.

Збережіть файл.

### Крок 2.4: Запустити сервер

У терміналі в папці проекту:

```bash
python app.py
```

Має з’явитися щось на кшталт:

```
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
```

Сервер слухає порт **5000**. Щоб він був доступний з інтернету:

- **Якщо це VPS** — зазвичай достатньо відкрити порт 5000 у файрволі (наприклад, `ufw allow 5000` на Linux).
- **Якщо це комп’ютер вдома** — потрібен проброс порту 5000 на ваш роутері на цей комп’ютер (Port Forwarding). IP-адресу для пристрою тоді буде **публічна IP вашого будинку** (її можна дізнатися, наприклад, на сайті [2ip.ua](https://2ip.ua) або аналогічному).

Перевірка: у браузері на будь-якому пристрої в інтернеті відкрийте (підставте свій IP і токен):

```
http://ВАШ_IP:5000/heartbeat?token=XYZ
```

Якщо токен правильний, у відповіді має бути JSON з `"ok": true`. Якщо неправильний — помилка 403.

Після цього сервер готовий приймати heartbeat від ESP32.

---

## Частина 3: ESP32 з MicroPython (пристрій, що надсилає heartbeat)

У проекті є приклад **`esp32_heartbeat.py`** — скрипт для платки ESP32 на MicroPython. Він підключається до Wi‑Fi і кожні 60 секунд надсилає GET-запит на ваш сервер.

### Крок 3.1: Підготовка ESP32

1. **Платка ESP32** (будь-яка з підтримкою MicroPython, наприклад ESP32-WROOM).
2. **USB-кабель** для підключення до комп’ютера.

### Крок 3.2: Прошити MicroPython

1. Завантажте прошивку MicroPython для ESP32 з офіційного сайту:  
   [https://micropython.org/download/ESP32_GENERIC/](https://micropython.org/download/ESP32_GENERIC/)  
   Виберіть останню стабільну (наприклад, `.bin` для вашої плати).

2. Встановіть **esptool** (у терміналі на комп’ютері):
   ```bash
   pip install esptool
   ```

3. Підключіть ESP32. Дізнайтеся порт:
   - **Windows:** Диспетчер пристроїв → порти (COM і LPT) — наприклад, `COM3`.
   - **Linux:** зазвичай `/dev/ttyUSB0`.
   - **macOS:** `/dev/cu.usbserial-...`.

4. **Перевести платку в режим прошивки (download mode).** Якщо з’явиться помилка *«Wrong boot mode detected (0x13)! The chip needs to be in download mode»*, зробіть так:
   - **Тримайте натисною** кнопку **BOOT** (часто підписана як **0** або **IO0**).
   - **Не відпускаючи BOOT**, один раз натисніть і відпустіть кнопку **RESET** (або **EN**).
   - Відпустіть **BOOT**.
   - Одразу після цього запустіть команду прошивки (крок 5). На деяких платах режим прошивки тримається лише кілька секунд.  
   Детальніше: [Troubleshooting esptool (Espressif)](https://docs.espressif.com/projects/esptool/en/latest/esp32/troubleshooting.html).

5. Стерти флеш і записати прошивку (замініть `COM3` на свій порт і `firmware.bin` на ім’я завантаженого файлу):
   ```bash
   python -m esptool --chip esp32 --port COM3 erase-flash
   python -m esptool --chip esp32 --port COM3 write-flash -z 0x1000 firmware.bin
   ```
   На Windows використовуйте саме `python -m esptool` (а не `esptool.py`), інакше команда може не знайтися в PATH.

Після цього на ESP32 встановлено MicroPython.

### Крок 3.3: Редактор та копіювання файлів (Thonny)

Зручно використовувати **Thonny** — він дозволяє підключитися до ESP32 і редагувати/завантажувати файли.

1. Встановіть Thonny: [https://thonny.org](https://thonny.org).
2. Підключіть ESP32 по USB.
3. У Thonny: **Run → Configure interpreter**. Виберіть **MicroPython (ESP32)** і порт вашої плати. Натисніть **OK**.
4. У меню **View** увімкніть **Files** — з’явиться дерево файлів. Одна сторона — ваш комп’ютер, інша — ESP32.

### Крок 3.4: Налаштувати esp32_heartbeat.py

На комп’ютері відкрийте **`esp32_heartbeat.py`** з проекту. Змініть на початку файлу:

```python
WIFI_SSID = "назва_вашої_wi-fi_мережі"
WIFI_PASS = "пароль_від_wi-fi"
VPS_IP = "123.45.67.89"       # Публічна IP вашого сервера (VPS або будинку)
VPS_PORT = 5000
TOKEN = "XYZ"                 # Той самий рядок, що й SECRET_TOKEN в app.py
INTERVAL_SEC = 60             # Як часто надсилати heartbeat (секунди)
```

- **VPS_IP** — той самий адресу, з якої ви відкривали в браузері `http://ВАШ_IP:5000/heartbeat?token=...`.
- **TOKEN** — **обов’язково** той самий, що в `app.py` у змінній `SECRET_TOKEN`.

Збережіть файл.

### Крок 3.5: Завантажити скрипт на ESP32 і запустити

1. У Thonny відкрийте `esp32_heartbeat.py`.
2. Клавішею **F5** або кнопкою **Run** запустіть скрипт. Thonny завантажить його на ESP32 і виконає. У консолі внизу має з’явитися підключення до Wi‑Fi, потім скрипт буде в циклі надсилати heartbeat кожні 60 секунд.

Якщо хочете, щоб після кожного перезавантаження ESP32 скрипт запускався сам:

1. У панелі файлів ESP32 (права сторона) натисніть правою кнопкою на `esp32_heartbeat.py` → **Upload as** → введіть ім’я **`main.py`**. Тепер при вмиканні платки буде автоматично виконуватися `main.py`, тобто ваш heartbeat-скрипт.

Перевірка: на сервері в логах (консоль, де запущено `python app.py`) мають з’являтися рядки на кшталт `heartbeat: OK from ...`. У Telegram після першого успішного heartbeat може прийти «✅ світло увімкнули» (якщо сервер до цього вважав пристрій офлайн).

---

## Структура проекту

| Файл | Призначення |
|------|-------------|
| **app.py** | Сервер: приймає heartbeat, зберігає час останнього сигналу, кожні 30 с перевіряє таймаут і відправляє повідомлення в Telegram. |
| **esp32_heartbeat.py** | Приклад клієнта для ESP32 (MicroPython): Wi‑Fi + GET на `/heartbeat?token=...` кожні 60 с. |
| **requirements.txt** | Залежності Python: `flask`, `requests`. |
| **README.md** | Ця інструкція. |

---

## Можливі проблеми

- **У Telegram нічого не приходить**  
  Перевірте: `TELEGRAM_TOKEN` і `CHAT_ID` в `app.py` правильні; бот доданий у канал як адмін (якщо використовуєте канал); ви хоча б раз написали боту в особисті (якщо використовуєте особистий чат).

- **Сервер не бачить heartbeat**  
  Переконайтеся, що на ESP32 вказані правильні `VPS_IP`, `VPS_PORT` і `TOKEN` (як в `SECRET_TOKEN`). Перевірте, що з браузера по `http://VPS_IP:5000/heartbeat?token=TOKEN` приходить `"ok": true`. Якщо сервер вдома — чи відкритий порт 5000 на роутері (Port Forwarding)?

- **ESP32 не підключається до Wi‑Fi**  
  Перевірте `WIFI_SSID` і `WIFI_PASS` (регістр літер має збігатися). Відстань до роутера — спробуйте ближче.

- **Повідомлення «Світло вимкнули» приходять занадто часто**  
  За замовчуванням таймаут — 5 хвилин. Його можна збільшити в `app.py`: змінна `HEARTBEAT_TIMEOUT_SEC = 5 * 60` (значення в секундах).

Якщо щось не виходить — перевірте логи сервера (консоль де запущено `python app.py`) та переконайтеся, що запити з ESP32 дійсно доходять (з’являються рядки `heartbeat: OK from ...`).

---

## Ліцензія та використання

Проект можна вільно використовувати та змінювати під свої потреби. Якщо ви змінюєте інтервали, порти або текст повідомлень — достатньо відредагувати константи в `app.py` та параметри в `esp32_heartbeat.py`.
